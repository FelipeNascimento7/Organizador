<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
        rel="stylesheet">
    <title>ORGANIZADOR</title>
    <style>
        :root {
            --primary-color: #4a67a5;
            --secondary-color: #4a67a5;
            --cinza: #212121;
            --background-color: #121212;
            --card-color: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #333333;
            --hover-color: #2d2d2d;
            --task-hoje-color-atrasada: #ff0000;
            --task-hoje-color-normal: #ffff00;
            --shadow: 0 2px 5px rgba(0, 0, 0, 0.3);

            /* Tamanhos responsivos base */
            --base-padding: clamp(1rem, 2vw, 1.5rem);
            --base-margin: clamp(0.5rem, 1.5vw, 1rem);
            --font-size-base: clamp(14px, 2vw, 16px);
            --font-size-large: clamp(18px, 3vw, 24px);
            --font-size-xlarge: clamp(24px, 4vw, 32px);
            --font-size-small: clamp(12px, 1vw, 14px);
            --border-radius: 4px;
            --max-width: 1200px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Nunito", sans-serif;
            font-optical-sizing: auto;
            font-weight: 400;
            font-style: normal;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            font-size: var(--font-size-base);
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            padding: var(--base-padding);
            line-height: 1.6;
            user-select: none;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            flex-direction: column;
            text-align: center;
            background-color: var(--primary);
            color: white;
            border-radius: 8px;
        }

        header h1 {
            margin: 0;
            ;
        }

        .tempo-restante {
            margin: 0;
            font-size: var(--font-size-small) * 3;
        }

        header p {
            margin: 0;
            font-size: var(--font-size-small);
        }


        .displayBlock {
            display: block;
        }

        .displayNone {
            display: none;
        }

        .content {
            display: none;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: var(--base-margin);
        }

        .container-opcoes {
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            align-items: center;
            margin-bottom: var(--base-margin);
            padding: 1rem;
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 4px;
            font-size: 0.7rem;
        }

        h1 {
            text-align: center;
            margin: var(--base-margin) 0 calc(var(--base-margin) * 2);
            color: var(--secondary-color);
            font-size: var(--font-size-xlarge);
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        h1:hover {
            opacity: 0.9;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            margin-bottom: var(--base-margin);
            padding: var(--base-padding);
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 4px;
            font-size: 0.9rem;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            cursor: pointer;
            color: var(--primary-color);
            text-decoration: none;
            margin: 0 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            display: inline-block;
            vertical-align: middle;
        }

        .breadcrumb-separator {
            margin: 0 8px;
            color: #999;
        }

        .add-task-container {
            display: flex;
            margin-bottom: var(--base-margin);
            flex-wrap: wrap;
            gap: var(--base-margin);
        }

        @media (max-width: 480px) {

            html,
            body {
                touch-action: pan-y;
                /* Permite apenas rolagem vertical */
                overscroll-behavior-y: contain;
                /* Opcional: melhora o comportamento da rolagem */
                scroll-behavior: smooth;
                -ms-overflow-style: none;
                /* IE e Edge */
                scrollbar-width: none;
                /* Firefox */
            }

            .breadcrumb-item {
                max-width: 100px;
            }

            .add-task-container {
                flex-direction: column;
            }

            .add-task-btn {
                width: 100%;
            }

            .task-btn.delete {
                padding: calc(var(--base-padding) * 0.25);
                font-size: 0.75rem;
            }

            .task-btn.edit {
                padding: calc(var(--base-padding) * 0.25);
                font-size: 0.75rem;
            }
        }

        .add-task-input {
            flex: 1;
            padding: calc(var(--base-padding) * 0.75) var(--base-padding);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
            background-color: var(--card-color);
            color: var(--text-color);
            width: 100%;
            max-width: 100%;
        }

        .add-task-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 103, 165, 0.2);
        }

        .add-task-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: calc(var(--base-padding) * 0.75) calc(var(--base-padding) * 1.5);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 0.95rem;
        }

        .add-task-btn.displayNone {
            display: none;
        }

        .add-task-btn.displayBlock {
            display: block;
        }

        .add-task-btn:hover {
            background-color: #3a5285;
            transform: translateY(-1px);
        }

        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .task-item {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: calc(var(--base-padding) * 0.75);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .task-content {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .task-title {
            font-size: 16px;
            word-break: break-word;
            flex: 1;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-left: 8px;
        }

        .task-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--secondary-color);
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }

        .task-btn:hover {
            background-color: var(--hover-color);
        }

        .subtasks-container {
            margin-top: 15px;
        }

        .subtask-form {
            display: flex;
            margin-top: 15px;
        }

        .subtask-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }

        .subtask-input:focus {
            border-color: var(--primary-color);
        }

        .add-subtask-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            margin-left: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .add-subtask-btn:hover {
            background-color: var(--secondary-color);
        }

        .subtask-item {
            background: var(--card-color);
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .subtask-text {
            flex: 1;
            word-break: break-word;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        .empty-state-hoje {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        .back-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .back-btn:hover {
            background-color: #5a6268;
        }

        .back-btn::before {
            content: "←";
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .action-btn {
            background-color: #5a6268;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .action-btn:hover {
            background-color: #6c757d;
        }

        .comment-item {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: calc(var(--base-padding) * 0.75);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .comment-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .comment-content {
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            gap: 10px;
        }

        .comment-content-btn {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }

        .comment-identificador {
            font-size: 16px;
            word-break: break-word;
            flex: 1;
            align-self: flex-start;
        }

        .comment-content-text {
            flex: 1;
            word-break: break-word;
        }

        .comment-title {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.452);
            word-break: break-word;
            flex: 1;
        }

        .comment-actions {
            display: flex;
            gap: 8px;
            margin-left: 8px;
        }

        .comment-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--secondary-color);
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }

        .comment-btn:hover {
            background-color: var(--hover-color);
        }

        #popup {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -30%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            background-color: var(--card-color);
            margin: 0 auto;
        }

        textarea {
            width: 100%;
            height: 100px;
            color: var(--text-color);
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: calc(var(--base-padding) * 0.75);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--secondary-color);
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }

        button:hover {
            background-color: var(--hover-color);
        }

        .action-buttons-popup {
            display: flex;
            direction: column;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .popupLabel {
            display: flex;
            justify-content: center;
            color: var(--text-color);
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 10px 20px;
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: var(--primary-color);
            background-color: var(--background-color);
            border-radius: 5px 5px 0 0;
            border-top: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            border-left: 1px solid var(--border-color);
        }

        .tab:hover {
            background-color: var(--card-color);
        }

        .tab.active {
            background-color: var(--primary-color);
            color: var(--background-color);
        }

        .containerTempoRestante {
            display: flex;
            flex-direction: column;
            text-align: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgb(11, 11, 11);
            color: white;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <header>
        <h1 id="title">ORGANIZADOR</h1>
        <div id="tempo-restante-container" class="containerTempoRestante" onclick="configurarTempoRestante()">
            <h1 id="tempo-restante" class="tempo-restante">00:00:00</h1>
            <p>Efésios 5:15-16</p>
        </div>
    </header>


    <div class="tabs">
        <div class="tab" data-tab="blocosContainer">BLOCOS</div>
        <div class="tab active" data-tab="hojeContainer" id="hojeTab">HOJE</div>
        <div class="tab" data-tab="ordemContainer" id="ordemTab" style="display: none;">ORDEM</div>
        <div class="tab" data-tab="opcoesContainer">OPÇÕES</div>
    </div>

    <div id="blocosContainer" class="content">

        <!--div class="action-buttons">
            <div id="backButtonContainer"></div>
            <button id="uncheckAllBtn" class="action-btn">Desmarcar Tudo</button>
        </div-->

        <div id="breadcrumb" class="breadcrumb"></div>


        <div class="add-task-container" id="addTaskContainer">
            <input type="text" class="add-task-input" placeholder="Adicione uma nova tarefa..." id="taskInput">
            <button class="add-task-btn displayBlock" id="addTaskBtn">Adicionar Bloco</button>
            <button class="add-task-btn displayNone" id="addCommentBtn">Adicionar Comentário</button>
        </div>

        <div class="tasks-list" id="tasksContainer">
            <div class="empty-state" id="emptyState">
                Nenhum bloco adicionada ainda. Comece adicionando seu primeiro bloco!
            </div>
        </div>
    </div>

    <div id="hojeContainer" class="content" style="display: block;">
        <div class="tasks-list" id="tasksContainer-hoje">
            <div class="empty-state-hoje" id="emptyState-hoje">
                Nenhum bloco para hoje!
            </div>
        </div>
    </div>

    <div id="ordemContainer" class="content" style="display: none;">
        <div class="tasks-list" id="tasksContainer-ordem">
            <div class="empty-state" id="emptyState-ordem">
                Nenhuma ordem para hoje!
            </div>
        </div>
    </div>

    <div id="opcoesContainer" class="content" style="display: none;">

        <div class="container-opcoes">
            <h2>Configurações</h2>
            <button onclick="atualziarTasks()">Atualizar Tarefas</button>
        </div>

        <div class="container-opcoes">
            <h2>Importar/Exportar</h2>
            <button onclick="openFileSelector()">Importar</button>
            <button onclick="exportTasksToCSV()">Exportar</button>
            <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
        </div>



    </div>

    <div id="popup" class="popup displayNone">
        <label for="textoComentario" class="popupLabel">Comentário</label><br>
        <textarea id="textoComentario"></textarea><br>
        <div class="action-buttons-popup">
            <button id="btnSalvarComentario">Salvar</button>
            <button id="btnCancelarComentario">Cancelar</button>
        </div>
    </div>

    <script>
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let tasksOrdenadas = JSON.parse(localStorage.getItem('tasksOrdenadas')) || [];
        let horaFinal = JSON.parse(localStorage.getItem('horaFinal')) || 24 * 60 * 60;
        let tempoRestante;
        let intervalTempoRestante = null;
        let dataAtualizacao = localStorage.getItem('dataAtualizacao') || new Date().getDate();

        const tempoRestanteDisplay = document.getElementById('tempo-restante');

        function openFileSelector() {
            document.getElementById('csvFileInput').click();
        }

        document.getElementById('csvFileInput').addEventListener('change', function (event) {
            const file = event.target.files[0];

            if (file) {
                importTasksFromCSV(file, (importedTasks) => {
                    tasks = importedTasks;
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                    alert('Tarefas importadas com sucesso!');
                    // Aqui você pode também atualizar a interface, se tiver um render()
                });
            }

            // Limpar o input para permitir reimportar o mesmo arquivo depois, se quiser
            event.target.value = '';
        });

        function importTasksFromCSV(file, callback) {
            const reader = new FileReader();

            reader.onload = function (event) {
                const csvText = event.target.result;
                const lines = csvText.split('\n').filter(Boolean);
                const [headerLine, ...dataLines] = lines;
                const headers = headerLine.split(';');

                const tasks = dataLines.map(line => {
                    const values = line.split(';');
                    const task = {};

                    headers.forEach((header, i) => {
                        let value = values[i];

                        if (value?.startsWith('"') && value.endsWith('"')) {
                            value = value.slice(1, -1).replace(/""/g, '"');
                        }

                        if (header === 'id' || header === 'diasRestantes') {
                            task[header] = Number(value);
                        } else if (header === 'diasRestantesAtivo' || header === 'istask') {
                            task[header] = value === 'true';
                        } else if (header === 'subtasks') {
                            try {
                                task[header] = JSON.parse(value || '[]');
                            } catch {
                                task[header] = [];
                            }
                        } else {
                            task[header] = value;
                        }
                    });

                    return task;
                });

                callback(tasks);
            };

            reader.readAsText(file, 'utf-8');
        }

        // Função de exportação
        function exportTasksToCSV() {
            const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
            const headers = ['id', 'diasRestantesAtivo', 'diasRestantes', 'text', 'subtasks', 'istask'];
            const csvRows = [headers.join(';')];

            for (const task of tasks) {
                const row = [
                    task.id,
                    task.diasRestantesAtivo,
                    task.diasRestantes,
                    `"${task.text.replace(/"/g, '""')}"`,
                    `"${JSON.stringify(task.subtasks).replace(/"/g, '""')}"`,
                    task.istask
                ];
                csvRows.push(row.join(';'));
            }

            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'tasks.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
            localStorage.setItem('tasksOrdenadas', JSON.stringify(tasksOrdenadas));
        }

        // Função para desmarcar todas as tarefas
        function atualziarTasks() {
            const confirmUncheck = confirm('Deseja realmente atualizar todas as tarefas?');
            if (!confirmUncheck) return;
            novadataAtualizacao = new Date().getDate();
            localStorage.setItem('dataAtualizacao', novadataAtualizacao);
            tasksOrdenadas = [];
            // Função recursiva para desmarcar todas as tarefas e subtarefas
            function uncheckTaskList(taskList) {
                taskList.forEach(task => {
                    if (task.diasRestantes <= 0 && task.viewed === true) {
                        task.diasRestantesAtivo = false;
                        task.diasRestantes = null;
                        task.viewed = false;
                    } else if (task.diasRestantesAtivo === true) {
                        task.diasRestantes -= 1;
                        task.viewed = false;
                    }
                    task.viewed = false;
                    if (task.subtasks && task.subtasks.length > 0) {
                        uncheckTaskList(task.subtasks);
                    }
                });
            }

            // Desmarca todas as tarefas principais
            uncheckTaskList(tasks);

            // Salva as alterações
            saveTasks();

            // Atualiza a visualização
            renderAll();
        }

        function renderAll() {
            location.reload();
        }


        function iniciarTempoRestante() {
            const tempoAtual = new Date().getHours() * 60 * 60 + new Date().getMinutes() * 60 + new Date().getSeconds();
            tempoRestante = horaFinal - tempoAtual;
            contarTempoRestante();
        }

        function contarTempoRestante() {
            if (intervalTempoRestante !== null) {
                clearInterval(intervalTempoRestante);
            }
            intervalTempoRestante = setInterval(() => {
                tempoRestante--;
                tempoRestanteDisplay.textContent = new Date(tempoRestante * 1000).toISOString().slice(11, 19);
                if (tempoRestante < 0) {
                    clearInterval(interval);
                }
            }, 1000);
        }

        iniciarTempoRestante();

        function configurarTempoRestante() {
            horaFinal = prompt('Digite a hora final');
            horaFinal = horaFinal * 60 * 60;
            localStorage.setItem('horaFinal', horaFinal);
            iniciarTempoRestante();
        }



        document.addEventListener('DOMContentLoaded', function () {
            const taskInput = document.getElementById('taskInput');
            const addTaskBtn = document.getElementById('addTaskBtn');
            const addCommentBtn = document.getElementById('addCommentBtn');
            const tasksContainer = document.getElementById('tasksContainer');
            const emptyState = document.getElementById('emptyState');
            const breadcrumb = document.getElementById('breadcrumb');
            const title = document.getElementById('title');
            //const backButtonContainer = document.getElementById('backButtonContainer');
            const blocosContainer = document.getElementById('blocosContainer');
            const hojeContainer = document.getElementById('hojeContainer');
            const opcoesContainer = document.getElementById('opcoesContainer');
            const addTaskContainer = document.getElementById('addTaskContainer');
            //const uncheckAllBtn = document.getElementById('uncheckAllBtn');
            const emptyStateHoje = document.getElementById('emptyState-hoje');
            const tasksContainerHoje = document.getElementById('tasksContainer-hoje');
            const popup = document.getElementById('popup');
            const textoComentario = document.getElementById('textoComentario');
            const btnSalvarComentario = document.getElementById('btnSalvarComentario');
            const btnCancelarComentario = document.getElementById('btnCancelarComentario');
            const tasksContainerOrdem = document.getElementById('tasksContainer-ordem');
            const emptyStateOrdem = document.getElementById('emptyState-ordem');
            const ordemTab = document.getElementById('ordemTab');


            btnSalvarComentario.addEventListener('click', salvarComentario);
            btnCancelarComentario.addEventListener('click', fecharPopup);


            // Adiciona o evento de clique ao botão Desmarcar Tudo
            //uncheckAllBtn.addEventListener('click', atualziarTasks);

            // Estado da navegação
            let navigationStack = [];

            // Carrega tarefas do localStorage
            renderHoje(tasks);

            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    tabs.forEach(t => t.classList.remove('active'));
                    if (document.getElementById(tabId).style.display === 'block' && tabId === 'hojeContainer') {
                        const hojeTab = document.getElementById('hojeTab');
                        const ordemTab = document.getElementById('ordemTab');

                        hojeTab.classList.remove('active');
                        hojeTab.style.display = 'none';
                        ordemTab.classList.add('active');
                        ordemTab.style.display = 'block';
                        document.getElementById('ordemContainer').style.display = 'block';
                        document.getElementById('hojeContainer').style.display = 'none';

                        renderOrdem(tasksOrdenadas);
                        return;
                    }
                    if (document.getElementById(tabId).style.display === 'block' && tabId === 'ordemContainer') {
                        const hojeTab = document.getElementById('hojeTab');
                        const ordemTab = document.getElementById('ordemTab');

                        ordemTab.classList.remove('active');
                        ordemTab.style.display = 'none';
                        hojeTab.classList.add('active');
                        hojeTab.style.display = 'block';
                        document.getElementById('ordemContainer').style.display = 'none';
                        document.getElementById('hojeContainer').style.display = 'block';
                        renderHoje(tasks);
                        return;
                    }
                    document.querySelectorAll('.content').forEach(t => t.style.display = 'none');
                    tab.classList.add('active');
                    document.getElementById(tabId).style.display = 'block';
                    if (tabId === 'hojeContainer') {
                        renderHoje(tasks);
                    }
                    if (tabId === 'blocosContainer') {
                        navigationStack = [];
                        renderTasks(tasks, 'Blocos Principais');
                    }
                    if (tabId === 'ordemContainer') {
                        renderOrdem(tasksOrdenadas);
                    }
                });
            });

            // Renderiza as tarefas principais inicialmente
            //renderTasks(tasks, 'Tarefas Principais');
            //renderHoje(tasks, 'Hoje');

            // Adiciona nova tarefa
            addTaskBtn.addEventListener('click', addTask);
            addCommentBtn.addEventListener('click', addComment);
            taskInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    if (addTaskBtn.classList.contains('displayBlock')) {
                        addTask();
                    } else {
                        addComment();
                    }
                }
            });

            function addTask() {
                const taskText = taskInput.value.trim();
                if (taskText) {
                    const parentId = navigationStack.length > 0 ?
                        navigationStack[navigationStack.length - 1].id :
                        null;

                    const newTask = {
                        id: Date.now(),
                        diasRestantesAtivo: false,
                        diasRestantes: 0,
                        text: taskText,
                        subtasks: [],
                        istask: true,
                    };

                    if (parentId) {
                        // Adiciona como subtarefa
                        const parentTask = findTaskById(parentId, tasks);
                        if (parentTask) {
                            parentTask.subtasks.push(newTask);
                        }
                    } else {
                        // Adiciona como tarefa principal
                        tasks.push(newTask);
                    }

                    saveTasks();
                    renderCurrentView();
                    taskInput.value = '';
                    taskInput.focus();
                } else {
                    addCommentBtn.classList.remove('displayNone');
                    addCommentBtn.classList.add('displayBlock');
                    addTaskBtn.classList.remove('displayBlock');
                    addTaskBtn.classList.add('displayNone');
                }
            }

            function addComment() {
                const commentText = taskInput.value.trim();
                if (commentText) {
                    const parentId = navigationStack.length > 0 ?
                        navigationStack[navigationStack.length - 1].id :
                        null;

                    const newComment = {
                        id: Date.now(),
                        text: commentText,
                        diasRestantesAtivo: false,
                        diasRestantes: null,
                        subtasks: [],
                        istask: false,
                    };

                    if (parentId) {
                        // Adiciona como subtarefa
                        const parentTask = findTaskById(parentId, tasks);
                        if (parentTask) {
                            parentTask.subtasks.push(newComment);
                        }
                    } else {
                        // Adiciona como tarefa principal
                        tasks.push(newComment);
                    }

                    saveTasks();
                    renderCurrentView();
                    taskInput.value = '';
                    taskInput.focus();
                } else {
                    addCommentBtn.classList.remove('displayBlock');
                    addCommentBtn.classList.add('displayNone');
                    addTaskBtn.classList.remove('displayNone');
                    addTaskBtn.classList.add('displayBlock');
                }
            }

            function renderCurrentView() {
                if (hojeContainer.style.display === 'block') {
                    renderHoje(tasks);
                } else {
                    if (navigationStack.length === 0) {
                        renderTasks(tasks, 'Tarefas Principais');
                    } else {
                        const currentTask = navigationStack[navigationStack.length - 1];
                        const parentTask = findTaskById(currentTask.id, tasks);
                        if (parentTask) {
                            renderTasks(parentTask.subtasks, currentTask.text, currentTask.id);
                        }
                    }
                }
            }

            function renderTasks(taskList, title, parentId = null) {
                let hoje = new Date().getDate();
                if (dataAtualizacao != hoje) {
                    dataAtualizacao = new Date().getDate();
                    localStorage.setItem('dataAtualizacao', dataAtualizacao);
                    atualziarTasks();
                }

                updateBreadcrumb(title, parentId);

                if (taskList.length === 0) {
                    emptyState.style.display = 'block';
                    tasksContainer.innerHTML = '';
                    tasksContainer.appendChild(emptyState);
                    return;
                }

                emptyState.style.display = 'none';
                tasksContainer.innerHTML = '';

                if (navigationStack.length === 0) {
                    taskList.forEach(task => {
                        task.pontos = contarPontos(task, true);
                    });

                    function contarPontos(task, primeiraChamada = false) {
                        const subtasks = task.subtasks;
                        if (subtasks.length === 0) {
                            if (task.diasRestantesAtivo && task.viewed === false) {
                                if (Number(task.diasRestantes) === 0){
                                    return -1;
                                }else{
                                    return Number(task.diasRestantes);
                                }
                            } else {
                                return 0;
                            }
                        } else {
                            let pontos = 0;
                            if (primeiraChamada == false) pontos = Number(task.diasRestantes);
                            subtasks.forEach(subtask => {
                                pontos += contarPontos(subtask);
                            });
                            return pontos;
                        }
                    }
                }

                if (navigationStack.length === 0) {
                    taskList.sort((a, b) => a.pontos - b.pontos);
                } else {
                    taskList.sort((a, b) => a.text.localeCompare(b.text));
                }

                taskList.forEach(task => {
                    let taskItem = [];
                    if (task.istask) {
                        taskItem = createTaskItem(task, parentId !== null);
                    } else {
                        taskItem = createCommentItem(task, parentId !== null);
                    }

                    tasksContainer.appendChild(taskItem);
                });
            }

            function atualziarTasks() {
                tasksOrdenadas = [];
                // Função recursiva para desmarcar todas as tarefas e subtarefas
                function uncheckTaskList(taskList) {
                    taskList.forEach(task => {
                        if (task.diasRestantes <= 0 && task.viewed === true) {
                            task.diasRestantesAtivo = false;
                            task.diasRestantes = null;
                            task.viewed = false;
                        } else if (task.diasRestantesAtivo === true) {
                            task.diasRestantes -= 1;
                            task.viewed = false;
                        }
                        task.viewed = false;
                        if (task.subtasks && task.subtasks.length > 0) {
                            uncheckTaskList(task.subtasks);
                        }
                    });
                }

                // Desmarca todas as tarefas principais
                uncheckTaskList(tasks);

                // Salva as alterações
                saveTasks();

                // Atualiza a visualização
                renderAll();
            }


            function filtrarTarefasPorDiasRestantes(taskList, diasRestantes, parentId = null) {
                let listaFiltrada = [];

                taskList.forEach(task => {
                    task.parentId = parentId;
                    if (task.diasRestantesAtivo == true && task.diasRestantes <= diasRestantes) {
                        listaFiltrada.push(task);
                    }
                    if (task.subtasks && task.subtasks.length > 0) {
                        const subtasksFiltradas = filtrarTarefasPorDiasRestantes(task.subtasks, diasRestantes, task.text);
                        listaFiltrada = listaFiltrada.concat(subtasksFiltradas);
                    }
                });
                return listaFiltrada;
            }


            function renderHoje(taskList, parentId = null) {
                let hojeTasks = filtrarTarefasPorDiasRestantes(taskList, 0);

                hojeTasks = removerPorId(hojeTasks, tasksOrdenadas);


                if ((hojeTasks.length === 0 || hojeTasks === null) && (tasksOrdenadas.length === 0 || tasksOrdenadas === null)) {
                    emptyStateHoje.style.display = 'block';
                    tasksContainerHoje.innerHTML = '';
                    tasksContainerHoje.appendChild(emptyStateHoje);
                    return;
                }

                hojeTasks.sort((a, b) => a.parentId.localeCompare(b.parentId));

                hojeTasks.sort((a, b) => {
                    if (a.parentId == b.parentId) {
                        return a.diasRestantes - b.diasRestantes;
                    } else {
                        return a.parentId - b.parentId;
                    }
                });

                emptyStateHoje.style.display = 'none';
                tasksContainerHoje.innerHTML = '';

                let contador = 1;
                tasksOrdenadas.forEach(task => {
                    let taskItem = [];
                    if (task.istask) {
                        taskItem = createTaskItem(task, parentId !== null, false, true, task.parentId, contador);
                    } else {
                        taskItem = createCommentItem(task, parentId !== null);
                    }
                    tasksContainerHoje.appendChild(taskItem);
                    contador++;
                });

                if (tasksOrdenadas.length > 0 && hojeTasks.length > 0) {
                    const separator = document.createElement('hr');
                    tasksContainerHoje.appendChild(separator);
                }

                hojeTasks.forEach(task => {
                    let taskItem = [];
                    if (task.istask) {
                        taskItem = createTaskItem(task, parentId !== null, true, false, task.parentId);
                    } else {
                        taskItem = createCommentItem(task, parentId !== null);
                    }
                    tasksContainerHoje.appendChild(taskItem);
                });

            }

            function removerPorId(array1, array2, chave = 'id') {
                // Cria um Set com os ids do array2 para busca rápida
                const idsParaRemover = new Set(array2.map(obj => obj[chave]));

                // Filtra array1 removendo objetos cujo id esteja no Set
                return array1.filter(obj => !idsParaRemover.has(obj[chave]));
            }

            function renderOrdem(taskList, parentId = null) {

                if (taskList.length === 0 || taskList === null) {
                    emptyStateOrdem.style.display = 'block';
                    tasksContainerOrdem.innerHTML = '';
                    tasksContainerOrdem.appendChild(emptyStateOrdem);
                    return;
                }

                emptyStateOrdem.style.display = 'none';
                tasksContainerOrdem.innerHTML = '';

                let contador = 1;
                taskList.forEach(task => {
                    let taskItem = [];
                    taskItem = createTaskItem(task, parentId !== null, false, true, task.parentId, contador);
                    tasksContainerOrdem.appendChild(taskItem);
                    contador++;
                });

            }

            function updateBreadcrumb(title, parentId) {
                breadcrumb.innerHTML = '';

                // Adiciona o item "Tarefas Principais" 
                const mainItem = document.createElement('div');
                mainItem.className = 'breadcrumb-item';
                mainItem.textContent = 'Início';
                mainItem.addEventListener('click', () => {
                    navigationStack.pop();
                    renderCurrentView();
                });
                breadcrumb.appendChild(mainItem);

                // Adiciona os itens do caminho atual
                navigationStack.forEach((item, index) => {
                    const separator = document.createElement('span');
                    separator.className = 'breadcrumb-separator';
                    separator.textContent = '›';
                    breadcrumb.appendChild(separator);

                    const crumbItem = document.createElement('div');
                    crumbItem.className = 'breadcrumb-item';
                    crumbItem.textContent = item.text;

                    if (index < navigationStack.length - 1) {
                        crumbItem.addEventListener('click', () => {
                            navigationStack = navigationStack.slice(0, index + 1);
                            renderCurrentView();
                        });
                    }

                    breadcrumb.appendChild(crumbItem);
                });
            }

            function createTaskItem(task, isSubtask, hoje = false, ordenada = false, parentId = null, contador = '') {

                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.dataset.id = task.id;

                const taskContent = document.createElement('div');
                taskContent.className = 'task-content';

                let taskTitle = document.createElement('div');
                taskTitle.className = 'task-title';
                taskTitle.textContent = task.text;


                if (hoje && task.diasRestantes < 0) {
                    taskTitle.style.color = 'var(--task-hoje-color-atrasada)';
                }
                if (hoje && task.diasRestantes >= 0) {
                    taskTitle.style.color = 'var(--task-hoje-color-normal)';
                }



                const taskActions = document.createElement('div');
                taskActions.className = 'task-actions';
                if (task.diasRestantesAtivo) {
                    const diasRestantes = document.createElement('div');
                    diasRestantes.className = 'task-diasRestantes';
                    diasRestantes.textContent = task.diasRestantes;
                    taskActions.appendChild(diasRestantes);
                }

                if (navigationStack.length === 0) {
                    const taskPontos = document.createElement('div');
                    taskPontos.className = 'task-title';
                    taskPontos.textContent = task.pontos;
                    taskActions.appendChild(taskPontos);
                }

                const editBtn = document.createElement('button');
                editBtn.className = 'task-btn edit';
                editBtn.innerHTML = '<i>EDITAR</i>';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const newTitle = prompt('Editar tarefa:', task.text);
                    let resultConfirm;
                    let dias = null;
                    if (navigationStack.length !== 0) {
                        if (task.diasRestantes === null) {
                            dias = 0;
                        } else {
                            dias = task.diasRestantes;
                        }

                        if (task.diasRestantesAtivo === true) {
                            resultConfirm = confirm('Manter dias restantes?');
                            if (resultConfirm) {
                                resultConfirm = confirm('Editar dias restantes?');
                                if (resultConfirm) {
                                    const diasRestantes = prompt('Dias para concluir:', dias);
                                    task.diasRestantes = diasRestantes;
                                    saveTasks();
                                }
                            } else {
                                task.diasRestantesAtivo = false;
                                task.diasRestantes = null;
                                saveTasks();
                            }
                        } else {
                            resultConfirm = confirm('Ativar dias restantes?');
                            if (resultConfirm) {
                                const diasRestantes = prompt('Dias para concluir:', dias);
                                task.diasRestantes = diasRestantes;
                                task.diasRestantesAtivo = true;
                                saveTasks();
                            }
                        }
                    }
                    if (newTitle !== null && newTitle.trim() !== '') {
                        task.text = newTitle.trim();
                        taskTitle.textContent = task.text;
                        saveTasks();
                    }
                    renderCurrentView();
                });

                const deleteBtn = document.createElement('button');
                const ordemBtn = document.createElement('button');
                const expulsaBtn = document.createElement('button');
                const subirBtn = document.createElement('button');

                deleteBtn.className = 'task-btn delete';
                deleteBtn.innerHTML = '<i>EXCLUIR</i>';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const confirmDelete = confirm(`Deseja realmente excluir a tarefa "${task.text}"?`);
                    if (!confirmDelete) return;
                    expulsaTarefa(task.id);
                    deleteTask(task.id);
                    renderHoje(tasks);
                    renderOrdem(tasksOrdenadas);
                    renderCurrentView();
                });

                if (hoje === true && ordenada === false) {
                    taskTitle.textContent = task.text + ' (' + parentId + ')';
                    ordemBtn.className = 'task-btn delete';
                    ordemBtn.innerHTML = '<i>P/ HOJE</i>';
                    ordemBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        ordenarTarefa(task.id, parentId);
                        renderHoje(tasks);
                    });
                }

                if (hoje === false && ordenada === true) {
                    taskTitle.textContent = contador + ': ' + task.text + ' (' + parentId + ')';
                    expulsaBtn.className = 'task-btn delete';
                    expulsaBtn.innerHTML = '<i>REMOVER</i>';
                    expulsaBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const confirmExpulsa = confirm(`Expulsar a tarefa "${task.text}"?`);
                        if (!confirmExpulsa) return;
                        expulsaTarefa(task.id);
                    });

                    subirBtn.className = 'task-btn delete';
                    subirBtn.innerHTML = '<i>REORDENAR</i>';
                    subirBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const confirmReordenar = prompt(`Digite o valor da nova posição:"${task.text}"?`);
                        if (confirmReordenar <= 0) { alert('O valor deve ser maior que 0'); return; }
                        if (!confirmReordenar) return;
                        reordenarTarefa(task.id, confirmReordenar);
                        renderHoje(tasks);
                    });
                }

                const tempoBtn = document.createElement('button');
                if (ordenada === true) {
                    tempoBtn.className = 'task-btn delete';
                    tempoBtn.innerHTML = '<i>TEMPO</i>';
                    tempoBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const confirmTempo = prompt(`Tempo da tarefa "${task.text}":`);

                        if (!confirmTempo) {
                            task.tempo = undefined;
                        } else {
                            task.tempo = confirmTempo;
                        }
                        saveTasks();
                        renderOrdem(tasksOrdenadas);
                        renderCurrentView();
                        renderHoje(tasks);
                    });
                }

                if (ordenada === true && task.tempo !== undefined && task.tempo !== null) {
                    taskTitle.textContent = taskTitle.textContent + ' - (Tempo: ' + task.tempo + 'min)';
                }

                taskContent.appendChild(taskTitle);



                if (ordenada === false) {
                    taskActions.appendChild(editBtn);
                }

                taskActions.appendChild(deleteBtn);

                if (hoje === true && ordenada === false) {
                    taskActions.appendChild(ordemBtn);
                }
                if (ordenada === true) {
                    taskActions.appendChild(tempoBtn);
                }


                if (ordenada === true && hoje === false) {
                    taskActions.appendChild(expulsaBtn);
                    taskActions.appendChild(subirBtn);
                }

                taskItem.appendChild(taskContent);
                taskItem.appendChild(taskActions);

                // Initialize viewed status if it doesn't exist
                if (task.viewed === undefined) {
                    task.viewed = false;
                }

                taskItem.addEventListener('click', (e) => {
                    if (e.target !== deleteBtn && !deleteBtn.contains(e.target) && !taskCheckbox.contains(e.target)) {
                        // Mark task as viewed when clicked
                        if (task.diasRestantesAtivo === false) {
                            task.viewed = true;
                        }

                        // If this is a parent task with subtasks, mark all subtasks as viewed
                        /*if (task.subtasks && task.subtasks.length > 0) {
                            task.subtasks.forEach(subtask => {
                                subtask.viewed = true;
                            });
                        }*/

                        navigationStack.push({ id: task.id, text: task.text });
                        renderTasks(task.subtasks, task.text, task.id);
                        saveTasks(); // Save the viewed status
                    }
                    if (e.target === taskCheckbox) {
                        task.viewed = !task.viewed;
                        saveTasks();
                    }
                });

                // Create a checkbox that indicates if the task has been viewed
                const taskCheckbox = document.createElement('input');
                taskCheckbox.type = 'checkbox';
                taskCheckbox.className = 'task-checkbox';
                taskCheckbox.style.marginRight = '10px';
                //taskCheckbox.style.cursor = 'default'; // Impede que o cursor mude para pointer
                //taskCheckbox.style.pointerEvents = 'none'; // Impede interação do usuário

                /*// Check if task has been viewed or all subtasks have been viewed
                const allSubtasksViewed = task.subtasks && task.subtasks.length > 0
                    ? task.subtasks.every(subtask => subtask.viewed === true)
                    : false;*/

                // Check the checkbox if task has been viewed or all subtasks have been viewed
                taskCheckbox.checked = task.viewed /*|| allSubtasksViewed);*/

                // Add some styling to the checkbox
                taskCheckbox.style.width = '16px';
                taskCheckbox.style.height = '16px';
                taskCheckbox.style.accentColor = '#4aa56b';

                taskContent.insertBefore(taskCheckbox, taskTitle);

                return taskItem;
            }

            function reordenarTarefa(id, novaPosicao) {
                const task = tasksOrdenadas.find(task => task.id === id);
                if (!task) return;
                /*if (novaPosicao > tasksOrdenadas.length) {
                    novaPosicao = tasksOrdenadas.length;
                }*/
                const index = tasksOrdenadas.indexOf(task);
                if (index >= 0) {
                    tasksOrdenadas.splice(index, 1);
                    tasksOrdenadas.splice(novaPosicao - 1, 0, task);
                }
                saveTasks();
                renderOrdem(tasksOrdenadas);
                renderHoje(tasks);
            }

            function subirTarefa(id) {
                const task = tasksOrdenadas.find(task => task.id === id);
                if (!task) return;
                const index = tasksOrdenadas.indexOf(task);
                if (index > 0) {
                    tasksOrdenadas.splice(index, 1);
                    tasksOrdenadas.splice(index - 1, 0, task);
                }
                saveTasks();
                renderOrdem(tasksOrdenadas);
                renderHoje(tasks);
            }

            function expulsaTarefa(id) {
                const task = tasksOrdenadas.find(task => task.id === id);
                if (!task) return;
                const index = tasksOrdenadas.indexOf(task);
                if (index > -1) {
                    tasksOrdenadas.splice(index, 1);
                }
                saveTasks();
                renderOrdem(tasksOrdenadas);
                renderHoje(tasks);
            }

            function createCommentItem(comment) {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                commentItem.dataset.id = comment.id;

                const commentContent = document.createElement('div');
                commentContent.className = 'comment-content';

                const commentIdentificador = document.createElement('div');
                commentIdentificador.className = 'comment-identificador';
                commentIdentificador.textContent = 'Comentário';

                const commentContentBtn = document.createElement('div');
                commentContentBtn.className = 'comment-content-btn';

                const commentText = document.createElement('div');
                commentText.className = 'comment-title';
                commentText.textContent = comment.text;

                const editBtn = document.createElement('button');
                editBtn.className = 'task-btn edit';
                editBtn.innerHTML = '<i>EDITAR</i>';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editarComentario(comment.id);
                    renderCurrentView();
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'task-btn delete';
                deleteBtn.innerHTML = '<i>EXCLUIR</i>';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const confirmDelete = confirm(`Deseja realmente excluir o comentário "${comment.text}"?`);
                    if (!confirmDelete) return;
                    deleteTask(comment.id);
                });


                commentContent.appendChild(commentIdentificador);
                commentContent.appendChild(editBtn);
                commentContent.appendChild(deleteBtn);
                //commentContent.appendChild(commentContentBtn);
                commentItem.appendChild(commentContent);
                commentItem.appendChild(commentText);



                return commentItem;
            }

            function editarComentario(commentId) {
                const popup = document.getElementById('popup');
                popup.classList.remove('displayNone');
                const textoComentario = document.getElementById('textoComentario');
                textoComentario.value = findTaskById(commentId, tasks).text;
                textoComentario.dataset.id = commentId;
            }

            function deleteTask(taskId) {
                if (navigationStack.length === 0) {
                    // Deletando tarefa principal
                    tasks = tasks.filter(task => task.id != taskId);
                } else {
                    // Deletando subtarefa
                    const parentId = navigationStack[navigationStack.length - 1].id;
                    const parentTask = findTaskById(parentId, tasks);
                    if (parentTask) {
                        parentTask.subtasks = parentTask.subtasks.filter(subtask => subtask.id != taskId);
                    }
                }

                saveTasks();
                renderCurrentView();
            }

            function deleteComment(commentId) {
                const parentId = navigationStack[navigationStack.length - 1].id;
                const parentTask = findTaskById(parentId, tasks);
                if (parentTask) {
                    parentTask.comments = parentTask.comments.filter(comment => comment.id != commentId);
                }
                saveTasks();
                renderCurrentView();
            }

            function findTaskById(id, taskList) {
                for (const task of taskList) {
                    if (task.id == id) return task;
                    if (task.subtasks && task.subtasks.length > 0) {
                        const found = findTaskById(id, task.subtasks);
                        if (found) return found;
                    }
                }
                return null;
            }

            function saveTasks() {
                localStorage.setItem('tasks', JSON.stringify(tasks));
                localStorage.setItem('tasksOrdenadas', JSON.stringify(tasksOrdenadas));
            }

            function fecharPopup() {
                const popup = document.getElementById('popup');
                popup.classList.add('displayNone');
            }

            function salvarComentario() {
                const textoComentario = document.getElementById('textoComentario');
                const comentario = textoComentario.value.trim();
                const comentarioId = textoComentario.dataset.id;
                setTextComentario(comentarioId, tasks, comentario);
                renderTasks(tasks, 'Blocos Principais');
                fecharPopup();
            }

            function setTextComentario(id, taskList, comentario) {
                for (const task of taskList) {
                    if (task.id == id) {
                        task.text = comentario;
                        saveTasks();
                        return;
                    }
                    if (task.subtasks && task.subtasks.length > 0) {
                        const found = setTextComentario(id, task.subtasks, comentario);

                        if (found) return found;
                    }
                }
                return null;
            }

            function ordenarTarefa(id, parentId) {
                const task = findTaskById(id, tasks);
                task.parentId = parentId;
                if (!tasksOrdenadas.some(t => t.id === task.id)) {
                    tasksOrdenadas.push(task);
                    saveTasks();
                } else {
                    alert('Tarefa já ordenada!');
                }
            }

        });

    </script>
</body>

</html>